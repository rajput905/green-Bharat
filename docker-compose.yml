version: '3.9'

# ─────────────────────────────────────────────────────────────────────────────
# GreenFlow AI – Production Docker Compose
# Services: PostgreSQL · FastAPI backend · Pathway engine
#           · Prometheus · Grafana · Streamlit UI
# ─────────────────────────────────────────────────────────────────────────────

x-common-env: &common-env
  DATABASE_URL: postgresql+asyncpg://postgres:${DB_PASSWORD:-password}@postgres-db:5432/greenflow
  APP_ENV: production

x-restart-policy: &always-restart
  restart: unless-stopped

services:

  # ── 1. PostgreSQL ────────────────────────────────────────────────────────
  postgres-db:
    image: postgres:15-alpine
    container_name: greenflow-db
    <<: *always-restart
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
      POSTGRES_DB: greenflow
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ── 2. FastAPI Backend ───────────────────────────────────────────────────
  api-backend:
    build:
      context: .
      target: runtime
    image: greenflow-api:latest
    container_name: greenflow-api
    <<: *always-restart
    command: >
      uvicorn main:app
        --host 0.0.0.0
        --port 8000
        --workers 2
        --loop uvloop
        --access-log
    ports:
      - "8000:8000"
    depends_on:
      postgres-db:
        condition: service_healthy
    environment:
      <<: *common-env
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      SECRET_KEY: ${SECRET_KEY:-changeme_in_production}
      WEATHER_API_KEY: ${WEATHER_API_KEY:-}
      AQI_API_KEY: ${AQI_API_KEY:-}
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
      - ./knowledge_base:/app/knowledge_base
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "com.greenflow.service=api"
      - "com.greenflow.version=2.0.0"

  # ── 3. Pathway Streaming Engine ──────────────────────────────────────────
  pathway-engine:
    build:
      context: .
      target: runtime
    image: greenflow-api:latest
    container_name: greenflow-engine
    <<: *always-restart
    command: python analytics_pipeline.py
    depends_on:
      postgres-db:
        condition: service_healthy
    environment:
      <<: *common-env
      WEATHER_API_KEY: ${WEATHER_API_KEY:-}
      AQI_API_KEY: ${AQI_API_KEY:-}
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    labels:
      - "com.greenflow.service=pipeline"

  # ── 4. Streamlit UI ──────────────────────────────────────────────────────
  streamlit-ui:
    build:
      context: .
      target: runtime
    image: greenflow-api:latest
    container_name: greenflow-ui
    <<: *always-restart
    command: >
      streamlit run frontend/app.py
        --server.port=8501
        --server.address=0.0.0.0
        --server.headless=true
    ports:
      - "8501:8501"
    depends_on:
      api-backend:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api-backend:8000/api/v1
    labels:
      - "com.greenflow.service=ui"

  # ── 5. Prometheus ────────────────────────────────────────────────────────
  prometheus:
    image: prom/prometheus:v2.50.0
    container_name: greenflow-prometheus
    <<: *always-restart
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.retention.time=15d'
    depends_on:
      - api-backend

  # ── 6. Grafana ───────────────────────────────────────────────────────────
  grafana:
    image: grafana/grafana:10.3.0
    container_name: greenflow-grafana
    <<: *always-restart
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-greenflow2025}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus

# ─────────────────────────────────────────────────────────────────────────────
# Persistent volumes
# ─────────────────────────────────────────────────────────────────────────────
volumes:
  postgres_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
